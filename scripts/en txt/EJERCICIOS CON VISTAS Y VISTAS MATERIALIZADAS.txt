--PARA LOS EJERCICIOS DE VISTA TRABAJERMOS EN EL EQUEMA HR
--verificamos que en el esquema HR 
--ya se cuenta con una vista creada
--su nombre es EMP_DETAILS_VIEW
--PARA VER SU CONTENIDO
SELECT * FROM EMP_DETAILS_VIEW;

--PARA VER LAS COLUMNAS Y NOMBRES QUE COMPONEN LA VISTA
DESC EMP_DETAILS_VIEW;

--para poder crear una nueva vista primero armar la consulta SQL
--generaremos una vista que nos muestre los nombres y apellidos de los empleados
--la fecha de ingreso a la compaÃ±ia y el departamento donde trabaja
--y su cargo que ejerce

CREATE VIEW V_EMPDEPJOB AS
SELECT FIRST_NAME AS "NOMBRE",LAST_NAME AS "APELLIDO",HIRE_DATE AS "FECHA_CONTRATACION",
JOB_TITLE AS "CARGO",DEPARTMENT_NAME AS "DEPARTAMENTO"
FROM EMPLOYEES E,DEPARTMENTS D,JOBS J
WHERE E.DEPARTMENT_ID=D.DEPARTMENT_ID AND 
E.JOB_ID=J.JOB_ID;

--PARA VER EL CONTENIDO DE LA VISTA GENERADA TODOS SUS CAMPOS
SELECT * FROM V_EMPDEPJOB;

--PARA VER ALGUNAS DE LAS COLUMNAS GENERADAS EN LA VISTA
SELECT NOMBRE,APELLIDO FROM V_EMPDEPJOB;

--SE PUEDE HACER OPERACIONES EN LA VISTA
SELECT CARGO,COUNT(*)
FROM V_EMPDEPJOB
GROUP BY CARGO;


SELECT DEPARTAMENTO,COUNT(*)
FROM V_EMPDEPJOB
GROUP BY DEPARTAMENTO;

--PARA VER LAS VISTAS EN LOS OBJETOS DE LA BASE DE DATOS
--EMPLEAMOS ALGUNOS SCRIPTS QUE NOS AYUDARAN

SELECT * FROM USER_CATALOG
WHERE TABLE_TYPE='VIEW';

SELECT * FROM USER_OBJECTS
WHERE OBJECT_TYPE='VIEW';

SELECT * FROM USER_VIEWS
WHERE VIEW_NAME LIKE 'V_%';

SELECT * FROM USER_VIEWS
WHERE VIEW_NAME LIKE '%VIEW';

--PARA VER EL CODIGO FUENTE DEL SQL QUE LO GENERO
SELECT TEXT FROM USER_VIEWS
WHERE VIEW_NAME LIKE 'V_%';


--PARA BORRAR UNA VISTA DE LA BASE DE DATOS
DROP VIEW V_EMPDEPJOB;


--VISTAS MATERIALIZADAS
--PARA QUE UN SUAURIO PUEDA GENERAR VISTAS AMETIARILZADAS
--DEBE TENER LOS PERMISOS SINO HAY QUE ASIGNARSELOS
--NOS CONECTAMOS AL USUARIO SYS QUE ES EL ADMINISTRADOR DE LA BASE DE DATOS

--VERIFICAMOS QUE PERMISOS TENEMOS EJECUTANDO EL SIGUIENTE SQL
SELECT * FROM USER_SYS_PRIVS;

--NOS CONECTAMOS CON EL USUARIO SYS Y OTORGAMOS EL PERMISO PARA QUE PUEDA EJECUTAR 
--LA CREACION DE VISTAS MATERIALIZADAS

GRANT CREATE MATERIALIZED VIEW TO HR;


--RETORNAMOS AL USUARIO HR PARA CREAR LA VISTA MATERIALIZADA
--CREAR UNA VISTA MATERIALIZADA QUE MUESTRE EL FISRTS_NAME Y LAST_NAME COMO EMPLEADO
--SU CARGO Y FECHA DE CONTRATACION
--EMPLEAREMOS LAS TABLAS EMPLOYEES Y JOB

CREATE MATERIALIZED VIEW VMAT_EMPJOB 
REFRESH COMPLETE ON DEMAND 
AS
SELECT FIRST_NAME||' '||LAST_NAME AS "EMPLEADO",HIRE_DATE AS "CONTRATADO",
JOB_TITLE AS "CARGO"
FROM EMPLOYEES E, JOBS J
WHERE E.JOB_ID=J.JOB_ID;

--AL IGUAL QUE EN LAS VISTAS NORMALES SE PUEDE 
--VER SU ESTRUCTURA Y CONSULTAR CAMPOS EN LA TABLA
DESC VMAT_EMPJOB;

SELECT * FROM VMAT_EMPJOB;

SELECT CARGO,COUNT(*)
FROM VMAT_EMPJOB
GROUP BY CARGO
ORDER BY CARGO;


--PARA ACTUALIZAR LOS DATOS EN LA VISTA MATERIALIZADA SE EMPLEAO LO SIGUIENTE
EXEC DBMS_MVIEW.REFRESH ('VMAT_EMPJOB',ATOMIC_REFRESH=>FALSE) ;


--PARA ELIMINAR UNA VISTA MATERIALIZADA SE EMPLEA DROP
DROP MATERIALIZED VIEW VMAT_EMPJOB;


--SI SE DESEA BORRAR LA VISTA MATERIALIZADA PERO CONSERVAR LA TABLE EN FISICO GENERADA
DROP MATERIALIZED VIEW VMAT_EMPJOB PRESERVE TABLE;