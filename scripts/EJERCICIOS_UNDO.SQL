SET SERVEROUTPUT ON;
--EJERCICIOS PRACTICOS UNDO
--ALGUNAS SENTENCIAS NECESARIAS PARA CONSULTAR ALGUNAS VISTAS DE UNDO

SHOW PARAMETER UNDO;

--MOUESTRA TODOS LOS TABLES SPACES DE ORACLE
SELECT * FROM DBA_TABLESPACES;

--MUESTRA SOLO EL TABLESPACE UE ES DE TIPO UNDO
SELECT * FROM DBA_TABLESPACES WHERE CONTENTS = 'UNDO';

--PARA VER EL ARCHIUVO FISICO UNDO
SELECT * FROM  DBA_DATA_FILES ;

SELECT * FROM  DBA_DATA_FILES WHERE TABLESPACE_NAME='UNDOTBS1';

--CREAMOS UNA TABLA Y VEMOS COMO ANDAN LAS TRANSACCIONES
--USAMOS LA VISTA V$TRANSACTION

SELECT * FROM V$TRANSACTION;

CREATE TABLE EJEMPLO (NOMBRE VARCHAR2(30));

INSERT  INTO EJEMPLO VALUES ('INF272');

SELECT * FROM V$TRANSACTION;

COMMIT;

SELECT * FROM V$TRANSACTION;

--HACEMOS OTRO EJEMPLO CON UPDATE 

UPDATE EJEMPLO SET NOMBRE = 'PRUEBA UNDO';

SELECT * FROM V$TRANSACTION;

INSERT  INTO EJEMPLO VALUES ('INF161');

SELECT * FROM V$TRANSACTION;

COMMIT;

SELECT * FROM V$TRANSACTION;

--PARA CREAR UN TABLESPACE UNDO

CREATE UNDO TABLESPACE UNDOTBS2 DATAFILE 'D:\app\Desktop\product\21c\oradata\XE\UNDOTBS02.DBF' 
SIZE 100M AUTOEXTEND ON NEXT 10M MAXSIZE 250M;

--PARA VER LA TABLA CREADA 
SELECT * FROM DBA_TABLESPACES WHERE CONTENTS = 'UNDO';

SHOW PARAMETER UNDO;

--PARA CAMBIAR EL TABLESPACE UNDO POR DEFECTO

ALTER SYSTEM SET UNDO_TABLESPACE = UNDOTBS2 SCOPE = BOTH;

SHOW PARAMETER UNDO;

ALTER SYSTEM SET UNDO_TABLESPACE = UNDOTBS2 SCOPE = BOTH;


UPDATE EJEMPLO SET NOMBRE = 'PRUEBA DOS';

SELECT * FROM V$TRANSACTION;

SELECT * FROM  DBA_DATA_FILES;
SELECT * FROM  DBA_DATA_FILES WHERE TABLESPACE_NAME='UNDOTBS2';

COMMIT;

--COMO CAMBIAR EL PARAMETRO RETENTION
--PARA QUE ORACLE GUARDE LOS DATOS YA COMNFIRMADOS
SHOW PARAMETER UNDO;

ALTER SYSTEM SET UNDO_RETENTION = 1800;

ALTER TABLESPACE UNDOTBS2 RETENTION GUARANTEE;


--ALGUNAS VISTAS PARA UNDO
--
SELECT * FROM DBA_ROLLBACK_SEGS;

SELECT * FROM V$UNDOSTAT;

SELECT * FROM  V$ROLLSTAT;

SELECT * FROM  DBA_UNDO_EXTENTS;


--PARA BORRAR UN TABLESPACE UNDO

DROP TABLESPACE UNDOTBS1 INCLUDING CONTENTS AND DATAFILES;

SELECT * FROM  DBA_TABLESPACES;

SELECT * FROM  DBA_ROLLBACK_SEGS;
